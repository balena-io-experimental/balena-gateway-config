version: '2'
volumes:
  dbus-config:
services:
  iface-setup:
    build: ./iface-setup
    labels:
      io.balena.features.dbus: '1'
    restart: on-failure
    privileged: true
    environment:
      - 'DBUS_SYSTEM_BUS_ADDRESS=unix:path=/host/run/dbus/system_bus_socket'
  dbus:
    build: ./dbus
    restart: always
    privileged: true
    ports:
      - "55884:55884"
    volumes:
      - 'dbus-config:/etc/dbus-1/system.d/'
  bluez:
    build: ./bluez
    restart: always
    privileged: true
    network_mode: host
    cap_add:
      - NET_ADMIN
    environment:
      - 'DBUS_SYSTEM_BUS_ADDRESS=tcp:host=localhost,port=55884'
    depends_on:
      - dbus
  connman:
    build: ./connman
    restart: always
    privileged: true
    network_mode: host
    environment:
      - 'DBUS_SYSTEM_BUS_ADDRESS=tcp:host=localhost,port=55884'
    depends_on:
      - dbus
      - iface-setup
  gateway-config:
    build: ./gateway-config
    restart: always
    privileged: true
    environment:
      - 'DBUS_SYSTEM_BUS_ADDRESS=tcp:host=dbus,port=55884'
      # The system bus forbids a lot of actions by default, use the session
      # bus config instead
      #- 'DBUS_SESSION_BUS_ADDRESS=tcp:host=dbus,port=55884'
      #- 'DBUS_SYSTEM_BUS_ADDRESS=tcp:host=dbus,port=55887'
    volumes:
      - 'dbus-config:/mnt/dbus-config'
    depends_on:
      - dbus
      - bluez
      - connman
